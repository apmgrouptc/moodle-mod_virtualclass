/*
  2014 Pinky Sharma  {@link http://vidyamantra.com}
 @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
*/
var io={cfg:{},sock:null,wsuri:null,error:null,uniquesids:null,init:function(a,b){this.cfg=a;this.wsconnect()},wsconnect:function(){io.wsuri="wss://"+this.cfg.rid;"WebSocket"in window?this.sock=new WebSocket(io.wsuri):"MozWebSocket"in window?this.sock=new MozWebSocket(io.wsuri):(console.log("Browser does not support WebSocket!"),this.error=lang.wserror);var a=this;this.sock.onopen=function(){console.log("Connected to "+a.cfg.rid);$.event.trigger({type:"connectionopen"});a.userauthenticat();a.addclient()};
this.sock.binaryType="arraybuffer";this.sock.onmessage=function(a){io.onRecMessage(a)};this.sock.onerror=function(b){a.error=b;console.log("Error:"+b);$.event.trigger({type:"error",message:b})};this.sock.onclose=function(a){console.log("Connection Closed");$.event.trigger({type:"connectionclose",message:a.reason});console.log("Connection closed (wasClean = "+a.wasClean+", code = "+a.code+", reason = '"+a.reason+"')")}},userauthenticat:function(){var a=JSON.stringify({cfun:"authenticate",arg:{authuser:this.cfg.authuser,
authpass:this.cfg.authpass}});this.sock.send(a)},addclient:function(){var a=JSON.stringify({cfun:"joinroom",arg:{client:this.cfg.userid,roomname:this.cfg.room,user:this.cfg.userobj}});this.sock.send(a)},send:function(a){if(null==this.sock)console.log("socket is not created");else{"use strict";var b="broadcastToAll";a.hasOwnProperty("eddata")&&("initVcEditor"!=a.eddata&&"virtualclass-editor-operation"!=a.eddata&&(a.et="EditorRich"==virtualclass.currApp||"editorRich"==virtualclass.currApp?"editorRich":
"EditorCode"==virtualclass.currApp||"editorCode"==virtualclass.currApp?"editorCode":a.et),b="broadcast");var c={cfun:b,arg:{msg:a}};1<arguments.length&&(c.arg.touser=this.uniquesids[arguments[1]]);var d=JSON.stringify(c);this.sock.send(d);1==arguments.length&&(b={type:b,m:a,userto:c.arg.hasOwnProperty("touser")?c.arg.touser:"",user:virtualclass.uInfo.userobj},"broadcast"!=b.type&&(b=JSON.stringify(b),a.hasOwnProperty("sEnd")||a.hasOwnProperty("getMsPckt")||this.completeStorage(b)))}},sendBinary:function(a){this.sock.send(a.buffer);
this.dataBinaryStore(a)},dataBinaryStore:function(a){var b;"[object Int8Array]"==Object.prototype.toString.call(a)?(b="a",a=virtualclass.dtCon.base64EncArrInt(a)):"[object Uint8ClampedArray]"==Object.prototype.toString.call(a)&&(b="c",a=virtualclass.dtCon.base64EncArr(a));this.completeStorage(a,{type:b})},sendBinary_old:function(a){this.sock.send(a.buffer);var b=Array.prototype.join.call(a,",");"[object Int8Array]"==Object.prototype.toString.call(a)?b="a,"+a.length+","+b:"[object Uint8ClampedArray]"==
Object.prototype.toString.call(a)&&(b="c,"+a.length+","+b);this.completeStorage(b,!0)},onRecMessage:function(a){var b=this;if(a.data instanceof ArrayBuffer){$.event.trigger({type:"binrec",message:a.data});var c=new Uint8Array(a.data),c=101==c[0]?new Int8Array(c):new Uint8ClampedArray(c);this.dataBinaryStore(c)}else switch(c=JSON.parse(a.data),(!c.hasOwnProperty("userto")||c.hasOwnProperty("userto")&&c.m.hasOwnProperty("eddata"))&&io.completeStorage(a.data),a="",c.type){case "joinroom":console.log("New user join room "+
c.users);var d=null;null!=b.uniquesids&&$.each(c.clientids,function(a,c){void 0==b.uniquesids[a]&&(d=a)});b.uniquesids=c.clientids;$.event.trigger({type:"member_added",message:c.users,newuser:d});break;case "broadcastToAll":case "broadcast":void 0!=c.userto&&(a=c.userto);$.event.trigger({type:"newmessage",message:c.m,fromUser:c.user,toUser:a});break;case "userleft":void 0!=c.userto&&(a=c.userto);null!=b.uniquesids&&delete b.uniquesids[c.user.userid];$.event.trigger({type:"user_logout",fromUser:c.user,
message:"offline",toUser:a});break;case "leftroom":$.event.trigger({type:"member_removed",message:c.users});break;case "Unauthenticated":$.event.trigger({type:"authentication_failed",message:"Authentication failed"});break;case "Multiple_login":$.event.trigger({type:"Multiple_login"})}},disconnect:function(){this.sock.onclose=function(){};this.sock.close();console.log("i am closing this connection")},completeStorage:function(a,b,c){if(!virtualclass.hasOwnProperty("getContent")||!0!=virtualclass.getContent){if("undefined"==
typeof firstTime&&(referenceTime=window.pageEnter,firstTime=!0,!virtualclass.vutil.isPlayMode())){var d=virtualclass.storage.db.transaction(["allData"],"readwrite");if("undefined"!=typeof d){var e=d.objectStore("allData");e.openCursor().onsuccess=function(a){(a=a.target.result)&&a.value.hasOwnProperty("recObjs")&&(a.value.hasOwnProperty("bd")?e.clear():JSON.parse(a.value.recObjs).hasOwnProperty("authuser")||e.clear())}}}var d=(new Date).getTime(),f=d-referenceTime;"undefined"!=typeof c?virtualclass.storage.completeStorage(f,
void 0,void 0,c):"undefined"==typeof b?virtualclass.storage.completeStorage(f,a):virtualclass.storage.completeStorage(f,a,b);referenceTime=d}}};
